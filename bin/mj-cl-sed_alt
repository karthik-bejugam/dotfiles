#!/usr/bin/env bash

# mj-cl-sed clyde run_list run_away /etc/chef/client-config.json `cat /tmp/mj-flip/clyde-hosts.log `

#
# Ssh into given node with authentication and replace all strings
# matching fromstr with tostr
#
cl=${1}      ; shift
fromstr=${1} ; shift
tostr=${1}   ; shift
file=${1}    ; shift

script_dir=`dirname $0`
script_name=`basename $0`
mjuserdir=/tmp/mj-${USER}
mjhosts=${mjuserdir}/${cl}-hosts.log

echo $mjhosts
if [ ! -e "$mjhosts" ] ; then echo "Please run mj-cl-list to generate hosts first." ; exit ; fi

for host in `cat ${mjhosts}` ; do
  $script_dir/mj-ssh ${cl} ${host} "sudo sed -i 's/${fromstr}/${tostr}/' ${file}" &
done
